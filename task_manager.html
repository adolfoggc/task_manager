<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  </head>
  <body class="m-3">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="current-task-tab" data-bs-toggle="tab" data-bs-target="#current-task-tab-pane" type="button" role="tab" aria-controls="current-task-tab-pane" aria-selected="true">Task Atual</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="weekly-task-tab" data-bs-toggle="tab" data-bs-target="#weekly-task-tab-pane" type="button" role="tab" aria-controls="weekly-task-tab-pane" aria-selected="false">Tasks da Semana</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="monthly-task-tab" data-bs-toggle="tab" data-bs-target="#monthly-task-tab-pane" type="button" role="tab" aria-controls="monthly-task-tab-pane" aria-selected="false">Tasks do Mês</button>
      </li>
    </ul>
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="current-task-tab-pane" role="tabpanel" aria-labelledby="current-task-tab" tabindex="0">
        <form>
          <div class="row">
            <div class="mb-3 col-6">
              <label for="task_name" class="form-label">Nome</label>
              <input type="text" class="form-control" id="task_name">
            </div>
            <div class="mb-3 col-6">
              <label for="task_status" class="form-label">Status</label>
              <select type="text" class="form-control" id="task_status">
                <option value="not started">Not Started</option>
                <option value="started">Started</option>
                <option value="out of scope">Out of Scope</option>
                <option value="finished">Finished</option>
                <option value="delivered">Delivered</option>
                <option value="accepted">Accepted</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-6">
              <label for="task_alias" class="form-label">Apelido</label>
              <input type="text" class="form-control" id="task_alias">
              <div type="text" class="form-text">Se não desejar criar um apelido, daremos um.</div>
            </div>
            <div class="mb-3 col-6">
              <label for="task_link" class="form-label">Link</label>
              <input type="text" class="form-control" id="task_link" onchange="update_link()">
              <a href=""  id="external_link" class="form-text" target="_blank">Clique para abrir o link</a>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-6">
              <label for="task_comment" class="form-label">Novo Comentário</label>
              <textarea class="form-control" id="task_comment"></textarea>
            </div>
            <div class="mb-3 col-6">
              <label for="task_alias" class="form-label">Comentários Anteriores</label>
              <div class="accordion" id="accordion">
              </div>
            </div>
          </div>
          <input type="hidden" id="comments_count"/>
          <div class="btn btn-primary" onclick="save_current_task()">Update</div>
        </form>
      </div>
      <div class="tab-pane fade" id="weekly-task-tab-pane" role="tabpanel" aria-labelledby="weekly-task-tab" tabindex="0">...</div>
      <div class="tab-pane fade" id="monthly-task-tab-pane" role="tabpanel" aria-labelledby="monthly-task-tab" tabindex="0">...</div>
    </div>    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      $(function() {
        load_current_task();
        if($("#comments_count").val() == ""){
          $("#comments_count").val(0)
        }
      });
      
      //BASIC IO
      function save_local_storage(key, value){
        localStorage.setItem(key, value);
      }

      function get_current_task_data(){
        total_comments = $("#comments_count").val();
        new_comment = $("#task_comment").val();
        if(new_comment != ""){
          total_comments++; 
          $("#comments_count").val(total_comments);
          add_comment(total_comments, new_comment);
          $("#task_comment").val("");
        }

        comments = get_old_comments();
        
        json = {
          "task_name": $("#task_name").val(),
          "task_alias": $("#task_alias").val(),
          "task_status": $("#task_status").val(),
          "task_link": $("#task_link").val(),
          "comments_count":  total_comments,
          "comments": comments
        };

        //TEMP
        console.log(json)

        return JSON.stringify(json);
      }
      //END BASIC IO
      
      function filter_comments(comments){
        filtered = [];
        for(i = 0; i < comments.length - 1; i++){
          filtered.push(comments[i]);
        }

        return filtered;
      }

      function add_comment(number, comment){
        number = parseInt(number);
        current_date = new Date();
        comment = create_accordion_item(number, current_date, comment);
        add_accordion(comment)
      }

      function get_old_comments(){
        comments = $("#accordion").html().replace("\n              ", "").split("<div class=\"end\"></div>");
        comments = filter_comments(comments);

        return comments;
      }

      //TEMP
      function check_current_task(){
        console.log(get_current_task_data());
      }

      function update_link(){
        $("#external_link").attr('href', $("#task_link").val())
      }

      function save_current_task(){
        save_local_storage("current_task", get_current_task_data())
      }

      function load_current_task(){
        task = localStorage.getItem("current_task");
        task = JSON.parse(task);
        recover_current_task_data(task);
        update_link();
      }

      function recover_current_task_data(json){
        fields = ["task_name", "task_alias", "task_status", "task_link", "comments_count", "comments"]
        for(i = 0; i < fields.length; i++){
          task = fields[i];
          if(task == "comments"){
            html = ""
            for(j = 0; j < json[task].length; j++){
              html += json[task][j];
            }
            $("#accordion").html(html)
          } else {
            $("#" + task).val(json[task])
          }
        }
      }

      function create_accordion_item(number, date_time, comment){
        html = '<div class="accordion-item" id="accordion_' + number + '">';
        html +=   '<h2 class="accordion-header">';
        html +=     '<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse' + number + '" aria-expanded="true" aria-controls="collapse' + number + '">';
        html +=     date_time;
        html +=     '</button>';
        html +=   '</h2>';
        html +=   '<div id="collapse' + number + '" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">';
        html +=     '<div class="accordion-body">';
        html +=       "<strong></strong>";
        html +=       comment;
        html +=     '</div>';
        html +=   '</div>';
        html += '</div>';
        html += '<div class="end"></div>'

        return html;
      }
      
      function add_accordion(text){
        old_comments = $("#accordion").html()
        $("#accordion").html(old_comments + text);
      }
    
    </script>
    </body>
  </body>
</html>