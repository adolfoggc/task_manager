<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Task Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
  </head>
  <body class="m-3">
    <ul class="nav nav-tabs" id="myTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="current-task-tab" data-bs-toggle="tab" data-bs-target="#current-task-tab-pane" type="button" role="tab" aria-controls="current-task-tab-pane" aria-selected="true" onclick="save_active_tab('current-task-tab')">Task Atual</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="weekly-task-tab" data-bs-toggle="tab" data-bs-target="#weekly-task-tab-pane" type="button" role="tab" aria-controls="weekly-task-tab-pane" aria-selected="false" onclick="save_active_tab('weekly-task-tab')">Tasks da Semana</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="monthly-task-tab" data-bs-toggle="tab" data-bs-target="#monthly-task-tab-pane" type="button" role="tab" aria-controls="monthly-task-tab-pane" aria-selected="false" onclick="save_active_tab('monthly-task-tab')">Tasks do Mês</button>
      </li>
    </ul>
    <div class="tab-content" id="myTabContent">
      <div class="tab-pane fade show active" id="current-task-tab-pane" role="tabpanel" aria-labelledby="current-task-tab" tabindex="0">
        <form>
          <div class="row">
            <div class="mb-3 col-6">
              <label for="task_name" class="form-label">Nome</label>
              <input type="text" class="form-control" id="task_name" onchange="update_field('task_name')">
            </div>
            <div class="mb-3 col-2">
              <label for="task_status" class="form-label">Status</label>
              <select type="text" class="form-control" id="task_status" onchange="update_field('task_status')">
                <option value="not started">Not Started</option>
                <option value="started">Started</option>
                <option value="out of scope">Out of Scope</option>
                <option value="finished">Finished</option>
                <option value="delivered">Delivered</option>
                <option value="accepted">Accepted</option>
              </select>
            </div>
            <div class="mb-3 col-2">
              <label for="task_criticaly" class="form-label">Criticidade</label>
              <select type="text" class="form-control" id="task_criticaly" onchange="update_field('task_criticaly')">
                <option value="low">Baixa</option>
                <option value="medium">Média</option>
                <option value="high">Alta</option>
                <option value="critical">Crírtico</option>
              </select>
            </div>
            <div class="mb-3 col-2">
              <label for="task_stack" class="form-label">Stack</label>
              <select type="text" class="form-control" id="task_stack" onchange="update_field('task_stack')">
                <option value="development">Desenvolvimento</option>
                <option value="test">Teste</option>
                <option value="produtcion">Produção</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-6">
              <label for="task_alias" class="form-label">Apelido</label>
              <input type="text" class="form-control" id="task_alias" onchange="update_field('task_alias')">
              <div type="text" class="form-text">Se não desejar criar um apelido, daremos um.</div>
            </div>
            <div class="mb-3 col-6">
              <label for="task_link" class="form-label">Link</label>
              <input type="text" class="form-control" id="task_link" onchange="update_link()">
              <a href=""  id="external_link" class="form-text" target="_blank">Clique para abrir o link</a>
            </div>
          </div>
          <div class="row">
            <div class="mb-3 col-6">
              <label for="task_comment" class="form-label">Novo Comentário</label>
              <textarea class="form-control" id="task_comment" onfocusout="check_comment()"></textarea>
              <br>
              <div class="btn btn-primary" id="new_comment" onclick="add_new_comment()">Update</div>
              <div class="btn btn-danger" id="new_current_task" onclick="check_creat_current_task()">Apagar</div>
            </div>
            <div class="mb-3 col-6">
              <label for="task_alias" class="form-label">Comentários Anteriores</label>
              <div class="accordion" id="accordion">
              </div>
            </div>
          </div>
          <input type="hidden" id="comments_count"/>
        </form>
      </div>
      <div class="tab-pane fade" id="weekly-task-tab-pane" role="tabpanel" aria-labelledby="weekly-task-tab" tabindex="-1">
        <!-- 
          0 - Salvar aba selecionada
          1 - Exibir tasks atuais, não ativas
          2 - Fácil ver o status e último comentário da task
          3 - Possibilidade de clickar em uma task e a tornar ativa
          4 - Protrack em um click
          5 - Todo conteúdo das tasks deve ser salvo em arquivo
          6 - Botão de limpar tasks da semana
        -->
        <div class="row">
          <div class="col-6 mb-3">
            Hello
          </div>
          <div class="col-6 mb-3">
            man
          </div>
        </div>
      </div>
      <div class="tab-pane fade" id="monthly-task-tab-pane" role="tabpanel" aria-labelledby="monthly-task-tab" tabindex="-1">...</div>
    </div>    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js" integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
      $(function() {
        load_active_tab();
        load_current_task();
        if($("#comments_count").val() == ""){
          $("#comments_count").val(0)
        }
        $("#new_comment").hide();
      });
      //BASIC FUNCTIONS
      function save_local_storage(key, value){
        localStorage.setItem(key, value);
      }
      //END BASIC FUNCTIONS

      //TAB JS
      function load_active_tab(){
        tab = localStorage.getItem("active");
        tabs = ['current-task-tab', 'weekly-task-tab', 'monthly-task-tab']
        for(i = 0; i < tab.length; i++){
          if(tabs[i] == tab){
            activate_tab(tab);
          } else {
            inactivate_tab(tabs[i]);
          }
        }
      }

      function save_active_tab(tab){
        save_local_storage("active", tab);
      }

      function inactivate_tab(tab){
        $('#'+tab+'-pane').removeClass('show');
        $('#'+tab+'-pane').removeClass('active');
        $('#'+tab+'-pane').attr('tabindex', '-1');
        $('#'+tab).removeClass('active');
      }

      function activate_tab(tab){
        $('#'+tab+'-pane').addClass('show');
        $('#'+tab+'-pane').addClass('active');
        $('#'+tab+'-pane').attr('tabindex', '0');
        $('#'+tab).addClass('active');
      }
      //END TAB JS

      //BASIC IO TAB 1
      function updated_comments_to_string(){
        json = get_current_task_json()
        total_comments = parseInt(json["comments_count"]);
        new_comment = $("#task_comment").val();
        add_comment(total_comments, new_comment);
        $("#task_comment").val("");
        comments = get_all_comments();
        json["comments"] = comments
        json["comments_count"] = parseInt(json["comments_count"]) + 1

        return JSON.stringify(json);
      }

      function update_field(field){
        json = get_current_task_json()
        json[field] = $("#"+field).val()
        save_local_storage("current_task", JSON.stringify(json))
      }
      //END BASIC IO
      
      function filter_comments(comments){
        filtered = [];
        for(i = 0; i < comments.length - 1; i++){
          filtered.push(comments[i]);
        }

        return filtered;
      }

      function clear_all_current_task_fields(){
        $("#accordion").html("");
        $("#").html("");
      }

      function check_creat_current_task(){
        if (confirm("Deseja apagar a task atual?") == true) {
          
        }
      }

      function add_comment(number, comment){
        number = parseInt(number);
        current_date = new Date();
        comment = create_accordion_item(number, current_date, comment);
        add_accordion(comment);
        $("#new_comment").hide();
      }

      function get_all_comments(){
        comments = $("#accordion").html().replace("\n              ", "").split("<div class=\"end\"></div>");
        comments = filter_comments(comments);

        return comments;
      }

      function update_link(){
        update_field("task_link")
        $("#external_link").attr('href', $("#task_link").val())
      }

      function add_new_comment(){
        save_local_storage("current_task", updated_comments_to_string())
      }

      function get_current_task_json(){
        return JSON.parse(localStorage.getItem("current_task"));
      }

      function check_comment(){
        if($("#task_comment").val()){
          $("#new_comment").show();
        } else {
          $("#new_comment").hide();
        }
      }

      function load_current_task(){
        task = get_current_task_json()
        recover_current_task_data(task);
        update_link();
      }

      function recover_current_task_data(json){
        fields = ["task_name", "task_alias", "task_status", "task_link", "comments_count", "comments", "task_criticaly", "task_stack"]
        for(i = 0; i < fields.length; i++){
          task = fields[i];
          if(task == "comments"){
            html = ""
            for(j = 0; j < json[task].length; j++){
              html += json[task][j];
            }
            $("#accordion").html(html)
          } else {
            $("#" + task).val(json[task])
          }
        }
      }

      function create_accordion_item(number, date_time, comment){
        html = '<div class="accordion-item" id="accordion_' + number + '">';
        html +=   '<h2 class="accordion-header">';
        html +=     '<button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse' + number + '" aria-expanded="true" aria-controls="collapse' + number + '">';
        html +=     date_time;
        html +=     '</button>';
        html +=   '</h2>';
        html +=   '<div id="collapse' + number + '" class="accordion-collapse collapse show" data-bs-parent="#accordionExample">';
        html +=     '<div class="accordion-body">';
        html +=       "<strong></strong>";
        html +=       comment;
        html +=     '</div>';
        html +=   '</div>';
        html += '</div>';
        html += '<div class="end"></div>'

        return html;
      }
      
      function add_accordion(text){
        old_comments = $("#accordion").html()
        $("#accordion").html(old_comments + text);
      }
    
    </script>
    </body>
  </body>
</html>